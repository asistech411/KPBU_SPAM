<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Alokasi Risiko KPBU SPAM</title>
    <style>
        :root{--primary:#1e3a5f;--primary-light:#2d5a87;--primary-dark:#0f1f33;--accent:#e8b44a;--accent-light:#f5d78e;--success:#2ecc71;--warning:#f39c12;--danger:#e74c3c;--bg:#f8f9fa;--bg-card:#fff;--text:#2c3e50;--text-light:#7f8c8d;--border:#e0e4e8;--shadow:0 4px 20px rgba(30,58,95,.08);--radius:12px;--radius-sm:8px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh}
        .header{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:#fff;padding:1rem 2rem;position:sticky;top:0;z-index:100;box-shadow:var(--shadow)}
        .header-content{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
        .logo{display:flex;align-items:center;gap:.75rem;font-weight:600;font-size:1.1rem}
        .logo svg{width:32px;height:32px}
        .stepper-container{background:var(--bg-card);padding:1rem 2rem;border-bottom:1px solid var(--border)}
        .stepper{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;overflow-x:auto;gap:.5rem;padding:.5rem 0}
        .step{display:flex;flex-direction:column;align-items:center;gap:.25rem;min-width:60px;cursor:pointer;transition:all .3s ease;opacity:.5}
        .step.active{opacity:1}
        .step.completed{opacity:.8}
        .step-number{width:32px;height:32px;border-radius:50%;background:var(--border);color:var(--text-light);display:flex;align-items:center;justify-content:center;font-size:.85rem;font-weight:600;transition:all .3s ease}
        .step.active .step-number{background:var(--primary);color:#fff}
        .step.completed .step-number{background:var(--success);color:#fff}
        .step-label{font-size:.7rem;text-align:center;color:var(--text-light);max-width:80px}
        .step.active .step-label{color:var(--primary);font-weight:600}
        .progress-bar-container{background:var(--bg-card);padding:.5rem 2rem 1rem;border-bottom:1px solid var(--border)}
        .progress-bar{max-width:1200px;margin:0 auto;height:6px;background:var(--border);border-radius:3px;overflow:hidden}
        .progress-fill{height:100%;background:linear-gradient(90deg,var(--primary) 0%,var(--accent) 100%);border-radius:3px;transition:width .5s ease}
        .progress-text{text-align:center;font-size:.75rem;color:var(--text-light);margin-top:.5rem}
        .main{max-width:1000px;margin:2rem auto;padding:0 1.5rem}
        .page{display:none;animation:fadeIn .4s ease}
        .page.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .card{background:var(--bg-card);border-radius:var(--radius);box-shadow:var(--shadow);padding:2rem;margin-bottom:1.5rem}
        .card-title{font-size:1.5rem;font-weight:700;color:var(--primary);margin-bottom:.5rem;display:flex;align-items:center;gap:.75rem}
        .card-subtitle{color:var(--text-light);margin-bottom:1.5rem;font-size:.95rem}
        .form-group{margin-bottom:1.5rem}
        .form-label{display:block;font-weight:600;margin-bottom:.5rem;color:var(--text)}
        .form-label-sub{font-weight:normal;color:var(--text-light);font-size:.85rem}
        .form-input,.form-select,.form-textarea{width:100%;padding:.75rem 1rem;border:2px solid var(--border);border-radius:var(--radius-sm);font-size:1rem;transition:all .3s ease;background:#fff}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(30,58,95,.1)}
        .form-textarea{min-height:100px;resize:vertical}
        .checkbox-group,.radio-group{display:flex;flex-direction:column;gap:.75rem}
        .checkbox-group.horizontal,.radio-group.horizontal{flex-direction:row;flex-wrap:wrap}
        .checkbox-label,.radio-label{display:flex;align-items:center;gap:.75rem;cursor:pointer;padding:.75rem 1rem;border:2px solid var(--border);border-radius:var(--radius-sm);transition:all .3s ease;background:#fff}
        .checkbox-label:hover,.radio-label:hover{border-color:var(--primary-light);background:rgba(30,58,95,.02)}
        .checkbox-label.selected,.radio-label.selected{border-color:var(--primary);background:rgba(30,58,95,.05)}
        .checkbox-label input,.radio-label input{width:20px;height:20px;accent-color:var(--primary)}
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.875rem 1.75rem;border:none;border-radius:var(--radius-sm);font-size:1rem;font-weight:600;cursor:pointer;transition:all .3s ease;text-decoration:none}
        .btn-primary{background:var(--primary);color:#fff}
        .btn-primary:hover{background:var(--primary-light);transform:translateY(-2px);box-shadow:var(--shadow)}
        .btn-secondary{background:var(--border);color:var(--text)}
        .btn-secondary:hover{background:#d0d5db}
        .btn-accent{background:var(--accent);color:var(--primary-dark)}
        .btn-accent:hover{background:var(--accent-light)}
        .btn-outline{background:transparent;border:2px solid var(--primary);color:var(--primary)}
        .btn-outline:hover{background:var(--primary);color:#fff}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-sm{padding:.5rem 1rem;font-size:.875rem}
        .btn-lg{padding:1.125rem 2.5rem;font-size:1.125rem}
        .btn-group{display:flex;gap:1rem;flex-wrap:wrap;margin-top:2rem}
        .fahp-grid{display:grid;gap:1rem}
        .fahp-pair{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:1rem;padding:1rem;background:var(--bg);border-radius:var(--radius-sm)}
        .fahp-risk{font-weight:600;text-align:center;padding:.5rem;background:#fff;border-radius:var(--radius-sm);border:1px solid var(--border)}
        .fahp-risk.left{text-align:right}
        .fahp-risk.right{text-align:left}
        .fahp-select{min-width:180px}
        .likert-grid{width:100%;border-collapse:separate;border-spacing:0;margin:1rem 0}
        .likert-grid th,.likert-grid td{padding:.75rem;text-align:center;border-bottom:1px solid var(--border)}
        .likert-grid th{background:var(--primary);color:#fff;font-weight:600;font-size:.85rem}
        .likert-grid th:first-child{border-radius:var(--radius-sm) 0 0 0;text-align:left}
        .likert-grid th:last-child{border-radius:0 var(--radius-sm) 0 0}
        .likert-grid td:first-child{text-align:left;background:var(--bg);font-size:.9rem}
        .likert-grid td:first-child strong{color:var(--primary)}
        .likert-grid tr:hover td{background:rgba(30,58,95,.02)}
        .likert-grid tr:hover td:first-child{background:var(--bg)}
        .likert-grid input[type="radio"]{width:20px;height:20px;accent-color:var(--primary);cursor:pointer}
        .tab-container{margin:1.5rem 0}
        .tab-nav{display:flex;gap:.5rem;border-bottom:2px solid var(--border);overflow-x:auto;padding-bottom:0}
        .tab-btn{padding:.75rem 1.25rem;border:none;background:none;font-size:.9rem;font-weight:600;color:var(--text-light);cursor:pointer;transition:all .3s ease;border-bottom:3px solid transparent;margin-bottom:-2px;white-space:nowrap}
        .tab-btn:hover{color:var(--primary)}
        .tab-btn.active{color:var(--primary);border-bottom-color:var(--primary)}
        .tab-btn.completed{color:var(--success)}
        .tab-btn.completed::after{content:' âœ“'}
        .tab-content{display:none;padding:1.5rem 0}
        .tab-content.active{display:block;animation:fadeIn .3s ease}
        .risk-sidebar{background:linear-gradient(135deg,var(--primary-dark) 0%,var(--primary) 100%);color:#fff;padding:1.5rem;border-radius:var(--radius);margin-bottom:1.5rem}
        .risk-sidebar h3{font-size:1rem;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
        .risk-item{padding:.75rem 0;border-bottom:1px solid rgba(255,255,255,.1);font-size:.85rem}
        .risk-item:last-child{border-bottom:none}
        .risk-item strong{color:var(--accent);display:block;margin-bottom:.25rem}
        .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem}
        .kpi-card{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%);color:#fff;padding:1.5rem;border-radius:var(--radius);text-align:center}
        .kpi-value{font-size:2rem;font-weight:700;margin-bottom:.25rem}
        .kpi-label{font-size:.85rem;opacity:.9}
        .kpi-card.warning{background:linear-gradient(135deg,var(--warning) 0%,#e67e22 100%)}
        .kpi-card.success{background:linear-gradient(135deg,var(--success) 0%,#27ae60 100%)}
        .chart-container{margin:1.5rem 0;padding:1rem;background:var(--bg);border-radius:var(--radius-sm)}
        .chart-title{font-weight:600;margin-bottom:1rem;text-align:center}
        .bar-chart{display:flex;flex-direction:column;gap:.75rem}
        .bar-item{display:grid;grid-template-columns:120px 1fr 60px;align-items:center;gap:1rem}
        .bar-label{font-size:.85rem;font-weight:500}
        .bar-label strong{color:var(--primary)}
        .bar-track{height:24px;background:var(--border);border-radius:12px;overflow:hidden}
        .bar-fill{height:100%;border-radius:12px;transition:width .8s ease}
        .bar-value{font-size:.85rem;font-weight:600;text-align:right}
        .donut-container{display:flex;align-items:center;justify-content:center;gap:2rem;flex-wrap:wrap}
        .donut-chart{width:200px;height:200px}
        .donut-legend{display:flex;flex-direction:column;gap:.5rem}
        .legend-item{display:flex;align-items:center;gap:.5rem;font-size:.85rem}
        .legend-color{width:16px;height:16px;border-radius:4px}
        .heatmap{display:grid;grid-template-columns:140px repeat(4,1fr);gap:2px;margin:1rem 0}
        .heatmap-header{background:var(--primary);color:#fff;padding:.5rem;text-align:center;font-size:.75rem;font-weight:600}
        .heatmap-cell{padding:.75rem .5rem;text-align:center;font-size:.85rem;font-weight:600}
        .heatmap-risk{background:var(--bg);font-weight:500;text-align:left;font-size:.8rem}
        .heatmap-risk strong{color:var(--primary)}
        .heat-low{background:#d5f5e3;color:#1e8449}
        .heat-medium{background:#fef9e7;color:#b7950b}
        .heat-high{background:#fadbd8;color:#922b21}
        .heat-critical{background:#e74c3c;color:#fff}
        .radar-mini{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem}
        .radar-card{background:var(--bg);padding:1rem;border-radius:var(--radius-sm)}
        .radar-title{font-weight:600;font-size:.9rem;margin-bottom:1rem;text-align:center}
        .construct-bars{display:flex;flex-direction:column;gap:.5rem}
        .construct-bar{display:grid;grid-template-columns:80px 1fr 30px;align-items:center;gap:.5rem;font-size:.8rem}
        .construct-track{height:8px;background:var(--border);border-radius:4px;overflow:hidden}
        .construct-fill{height:100%;background:var(--primary);border-radius:4px;transition:width .5s ease}
        .allocation-matrix{width:100%;border-collapse:collapse;margin:1rem 0;font-size:.9rem}
        .allocation-matrix th,.allocation-matrix td{padding:1rem;border:1px solid var(--border);text-align:center}
        .allocation-matrix th{background:var(--primary);color:#fff;font-weight:600}
        .allocation-matrix td:first-child{font-weight:600;text-align:left;background:var(--bg)}
        .alloc-public{background:#e8f4fd;color:#1565c0}
        .alloc-spv{background:#e8f5e9;color:#2e7d32}
        .alloc-shared{background:#fff3e0;color:#e65100}
        .alloc-epc{background:#f3e5f5;color:#7b1fa2}
        .alloc-na{background:#f5f5f5;color:#757575;font-style:italic}
        .confidence-high{color:var(--success)}
        .confidence-medium{color:var(--warning)}
        .confidence-low{color:var(--danger)}
        .accordion{margin:1rem 0}
        .accordion-item{border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:.5rem;overflow:hidden}
        .accordion-header{padding:1rem;background:var(--bg);cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:600;transition:all .3s ease}
        .accordion-header:hover{background:var(--border)}
        .accordion-header.active{background:var(--primary);color:#fff}
        .accordion-icon{transition:transform .3s ease}
        .accordion-header.active .accordion-icon{transform:rotate(180deg)}
        .accordion-content{display:none;padding:1rem;background:#fff}
        .accordion-content.active{display:block;animation:fadeIn .3s ease}
        .model-flow{display:flex;flex-direction:column;gap:1rem;padding:1.5rem;background:linear-gradient(135deg,var(--bg) 0%,#fff 100%);border-radius:var(--radius);margin:1.5rem 0}
        .flow-row{display:flex;justify-content:center;gap:1rem;flex-wrap:wrap}
        .flow-card{padding:1rem 1.5rem;background:#fff;border:2px solid var(--border);border-radius:var(--radius-sm);text-align:center;min-width:150px;transition:all .3s ease}
        .flow-card.input{border-color:var(--primary);background:rgba(30,58,95,.05)}
        .flow-card.process{border-color:var(--accent);background:rgba(232,180,74,.1)}
        .flow-card.output{border-color:var(--success);background:rgba(46,204,113,.1)}
        .flow-arrow{display:flex;align-items:center;justify-content:center;color:var(--text-light);font-size:1.5rem}
        .alert{padding:1rem 1.25rem;border-radius:var(--radius-sm);margin:1rem 0;display:flex;align-items:flex-start;gap:.75rem}
        .alert-info{background:#e3f2fd;border-left:4px solid #2196f3;color:#1565c0}
        .alert-warning{background:#fff3e0;border-left:4px solid #ff9800;color:#e65100}
        .alert-success{background:#e8f5e9;border-left:4px solid #4caf50;color:#2e7d32}
        .alert-danger{background:#ffebee;border-left:4px solid #f44336;color:#c62828}
        .validation-list{list-style:none;margin:1rem 0}
        .validation-list li{padding:.75rem 1rem;margin-bottom:.5rem;background:var(--bg);border-radius:var(--radius-sm);display:flex;align-items:center;gap:.75rem}
        .validation-list li.valid{background:#e8f5e9;color:#2e7d32}
        .validation-list li.invalid{background:#ffebee;color:#c62828}
        .landing-hero{text-align:center;padding:3rem 2rem;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:#fff;border-radius:var(--radius);margin-bottom:2rem}
        .landing-hero h1{font-size:2rem;margin-bottom:1rem}
        .landing-hero p{font-size:1.1rem;opacity:.9;max-width:600px;margin:0 auto 1.5rem}
        .time-estimate{display:inline-flex;align-items:center;gap:.5rem;background:rgba(255,255,255,.15);padding:.75rem 1.5rem;border-radius:50px;font-size:.95rem}
        .feature-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem}
        .feature-card{background:var(--bg-card);padding:1.5rem;border-radius:var(--radius);box-shadow:var(--shadow);text-align:center}
        .feature-icon{width:48px;height:48px;margin:0 auto 1rem;background:rgba(30,58,95,.1);border-radius:50%;display:flex;align-items:center;justify-content:center}
        .feature-icon svg{width:24px;height:24px;color:var(--primary)}
        .review-section{background:var(--bg);padding:1.5rem;border-radius:var(--radius-sm);margin-bottom:1rem}
        .review-section h4{color:var(--primary);margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
        .review-item{display:flex;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid var(--border)}
        .review-item:last-child{border-bottom:none}
        .export-buttons{display:flex;gap:.75rem;flex-wrap:wrap;margin:1.5rem 0}
        .hidden{display:none!important}
        .completeness{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem 1rem;background:var(--bg);border-radius:20px;font-size:.85rem;margin-bottom:1rem}
        .completeness.complete{background:#e8f5e9;color:#2e7d32}
        .completeness.incomplete{background:#fff3e0;color:#e65100}
        .locks-list{list-style:none;display:flex;flex-direction:column;gap:.5rem}
        .locks-list li{display:flex;align-items:flex-start;gap:.5rem;padding:.5rem;background:rgba(30,58,95,.05);border-radius:var(--radius-sm);font-size:.9rem}
        .locks-list li::before{content:'ðŸ”’';flex-shrink:0}
        .tier-badge{display:inline-block;padding:.25rem .75rem;border-radius:20px;font-size:.75rem;font-weight:600;text-transform:uppercase}
        .tier-badge.tier1{background:#e3f2fd;color:#1565c0}
        .tier-badge.tier2{background:#f3e5f5;color:#7b1fa2}
        @media print{.header,.stepper-container,.progress-bar-container,.btn-group,.export-buttons{display:none!important}.main{max-width:100%;margin:0;padding:0}.card{box-shadow:none;border:1px solid #ddd;page-break-inside:avoid}}
        @media(max-width:768px){.header{padding:1rem}.header-content{flex-direction:column;text-align:center}.step-label{display:none}.main{padding:0 1rem;margin:1rem auto}.card{padding:1.5rem}.card-title{font-size:1.25rem}.fahp-pair{grid-template-columns:1fr;text-align:center}.fahp-risk.left,.fahp-risk.right{text-align:center}.likert-grid{font-size:.8rem}.likert-grid th,.likert-grid td{padding:.5rem .25rem}.btn-group{flex-direction:column}.btn-group .btn{width:100%}.kpi-grid{grid-template-columns:1fr 1fr}.landing-hero h1{font-size:1.5rem}}
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                <span>Survey Alokasi Risiko KPBU SPAM</span>
            </div>
            <button class="btn btn-sm btn-secondary" onclick="resetAll()" title="Reset semua data">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                Reset
            </button>
        </div>
    </header>

    <div class="stepper-container"><div class="stepper" id="stepper"></div></div>
    <div class="progress-bar-container">
        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
        <div class="progress-text" id="progressText">Halaman 0 dari 9</div>
    </div>

    <main class="main">
        <!-- Page 0: Landing -->
        <div class="page active" id="page0">
            <div class="landing-hero">
                <h1>ðŸŒŠ Survey Alokasi Risiko Proyek KPBU SPAM</h1>
                <p>Selamat datang! Survey ini mengumpulkan persepsi Anda tentang kepentingan risiko, fase kritis, dan indikator untuk rekomendasi alokasi risiko yang adil pada proyek KPBU SPAM.</p>
                <div class="time-estimate">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    Estimasi waktu: 15â€“25 menit
                </div>
            </div>
            <div class="feature-grid">
                <div class="feature-card">
                    <div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></div>
                    <h3>Otomatis Tersimpan</h3>
                    <p>Jawaban disimpan otomatis. Anda bisa melanjutkan kapan saja.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
                    <h3>Kerahasiaan Terjaga</h3>
                    <p>Jawaban bersifat rahasia untuk kepentingan akademik.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg></div>
                    <h3>Hasil Langsung</h3>
                    <p>Lihat hasil analisis dan rekomendasi setelah submit.</p>
                </div>
            </div>
            <div class="card" style="margin-top:2rem">
                <h3 style="margin-bottom:1rem">ðŸ“‹ Struktur Survey</h3>
                <ol style="padding-left:1.5rem;line-height:2">
                    <li>Persetujuan partisipasi</li>
                    <li>Screening responden & pengalaman</li>
                    <li>Proyek referensi utama</li>
                    <li>FAHP: Perbandingan berpasangan 6 risiko</li>
                    <li>Lifecycle Mapping: Keterjadian & fase kritis</li>
                    <li>PAT Tier-1: Publik/PDAM â†” BU/SPV</li>
                    <li>PAT Tier-2: BU/SPV â†” EPC/O&M</li>
                    <li>Review & Submit</li>
                    <li>Hasil & Rekomendasi</li>
                </ol>
            </div>
            <div class="btn-group" style="justify-content:center">
                <button class="btn btn-primary btn-lg" onclick="nextPage()">Mulai Survey <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
            </div>
        </div>

        <!-- Page 1: Consent -->
        <div class="page" id="page1">
            <div class="card">
                <h2 class="card-title"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg> Lembar Informasi & Persetujuan</h2>
                <p class="card-subtitle">Silakan baca informasi berikut sebelum melanjutkan.</p>
                <div class="alert alert-info"><strong>Tujuan:</strong> Mengumpulkan persepsi tentang 6 risiko utama, fase kritis, dan indikator PAT untuk rekomendasi alokasi risiko.</div>
                <div class="alert alert-success"><strong>Kerahasiaan:</strong> Jawaban rahasia, hasil disajikan agregat tanpa menyebut nama.</div>
                <div class="alert alert-warning"><strong>Sukarela:</strong> Partisipasi sukarela, Anda dapat berhenti kapan saja.</div>
                <div class="form-group" style="margin-top:2rem">
                    <label class="checkbox-label" id="consentLabel">
                        <input type="checkbox" id="consent" onchange="updateConsent()">
                        <span>Saya telah membaca informasi di atas dan <strong>bersedia menjadi responden</strong>.</span>
                    </label>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Kembali</button>
                    <button class="btn btn-primary" onclick="nextPage()" id="consentNext" disabled>Lanjutkan <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
                </div>
            </div>
        </div>

        <!-- Page 2: Screening -->
        <div class="page" id="page2">
            <div class="card">
                <h2 class="card-title"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg> Screening Responden</h2>
                <p class="card-subtitle">Informasi latar belakang dan pengalaman Anda.</p>
                <div class="form-group">
                    <label class="form-label">SCR-01. Apakah Anda pernah terlibat dalam proyek KPBU SPAM atau PPP sejenis? <span style="color:var(--danger)">*</span></label>
                    <div class="radio-group horizontal">
                        <label class="radio-label"><input type="radio" name="scr01" value="Ya" onchange="updateScreening()"><span>Ya</span></label>
                        <label class="radio-label"><input type="radio" name="scr01" value="Tidak" onchange="updateScreening()"><span>Tidak</span></label>
                    </div>
                    <div class="alert alert-danger hidden" id="scr01Warning">Maaf, survey ini ditujukan untuk responden yang pernah terlibat dalam proyek KPBU SPAM.</div>
                </div>
                <div id="screeningFields" class="hidden">
                    <div class="form-group">
                        <label class="form-label">SCR-02. Peran utama Anda: <span style="color:var(--danger)">*</span></label>
                        <select class="form-select" id="scr02" onchange="saveData()">
                            <option value="">-- Pilih peran --</option>
                            <option value="Pemerintah/PJPK/Unit KPBU">Pemerintah/PJPK/Unit KPBU</option>
                            <option value="PDAM/Perumda">PDAM/Perumda</option>
                            <option value="BU Pelaksana/SPV">BU Pelaksana/SPV</option>
                            <option value="EPC/Kontraktor">EPC/Kontraktor</option>
                            <option value="Operator/O&M">Operator/O&M</option>
                            <option value="Konsultan">Konsultan (transaksi/teknis/hukum/keuangan)</option>
                            <option value="Penjamin/Lender/Advisor">Penjamin/Lender/Advisor</option>
                            <option value="Akademisi/LSM/Asosiasi">Akademisi/LSM/Asosiasi</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">SCR-03. Lama pengalaman: <span style="color:var(--danger)">*</span></label>
                        <div class="radio-group horizontal">
                            <label class="radio-label"><input type="radio" name="scr03" value="<3 tahun" onchange="saveData()"><span>&lt;3 tahun</span></label>
                            <label class="radio-label"><input type="radio" name="scr03" value="3-5 tahun" onchange="saveData()"><span>3â€“5 tahun</span></label>
                            <label class="radio-label"><input type="radio" name="scr03" value="6-10 tahun" onchange="saveData()"><span>6â€“10 tahun</span></label>
                            <label class="radio-label"><input type="radio" name="scr03" value=">10 tahun" onchange="saveData()"><span>&gt;10 tahun</span></label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">SCR-04. Fase KPBU yang pernah ditangani (boleh &gt;1): <span style="color:var(--danger)">*</span></label>
                        <div class="checkbox-group horizontal">
                            <label class="checkbox-label"><input type="checkbox" name="scr04" value="Perencanaan" onchange="saveData()"><span>Perencanaan</span></label>
                            <label class="checkbox-label"><input type="checkbox" name="scr04" value="Penyiapan" onchange="saveData()"><span>Penyiapan</span></label>
                            <label class="checkbox-label"><input type="checkbox" name="scr04" value="Transaksi" onchange="saveData()"><span>Transaksi</span></label>
                            <label class="checkbox-label"><input type="checkbox" name="scr04" value="Implementasi" onchange="saveData()"><span>Implementasi</span></label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">SCR-05. Apakah Anda memiliki dua peran/afiliasi yang berpotensi konflik?</label>
                        <div class="radio-group horizontal">
                            <label class="radio-label"><input type="radio" name="scr05" value="Tidak" onchange="saveData()"><span>Tidak</span></label>
                            <label class="radio-label"><input type="radio" name="scr05" value="Ya" onchange="saveData()"><span>Ya</span></label>
                        </div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Kembali</button>
                    <button class="btn btn-primary" onclick="nextPage()">Lanjutkan <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
                </div>
            </div>
        </div>

        <!-- Page 3: Project Reference -->
        <div class="page" id="page3">
            <div class="card">
                <h2 class="card-title"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg> Proyek Referensi Utama</h2>
                <p class="card-subtitle">Pilih 1 proyek yang paling Anda pahami. Jawab semua pertanyaan dengan konteks proyek ini.</p>
                <div class="alert alert-info">Tidak perlu menyebutkan nama proyek/lembaga untuk menjaga kerahasiaan.</div>
                <div class="form-group">
                    <label class="form-label">PR-01. Tipe proyek referensi: <span style="color:var(--danger)">*</span></label>
                    <div class="radio-group">
                        <label class="radio-label"><input type="radio" name="pr01" value="KPBU SPAM langsung" onchange="saveData()"><span>KPBU SPAM yang saya tangani langsung</span></label>
                        <label class="radio-label"><input type="radio" name="pr01" value="KPBU SPAM diketahui" onchange="saveData()"><span>KPBU SPAM yang saya ketahui sangat baik</span></label>
                        <label class="radio-label"><input type="radio" name="pr01" value="PPP sejenis" onchange="saveData()"><span>PPP air minum sejenis</span></label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">PR-02. Lokasi proyek (opsional):</label>
                    <input type="text" class="form-input" id="pr02Location" placeholder="Contoh: Jawa Barat" onchange="saveData()">
                </div>
                <div class="form-group">
                    <label class="form-label">PR-03. Skema pembayaran:</label>
                    <div class="radio-group horizontal">
                        <label class="radio-label"><input type="radio" name="pr03" value="AP" onchange="saveData()"><span>AP</span></label>
                        <label class="radio-label"><input type="radio" name="pr03" value="Tarif" onchange="saveData()"><span>Tarif</span></label>
                        <label class="radio-label"><input type="radio" name="pr03" value="Campuran" onchange="saveData()"><span>Campuran</span></label>
                        <label class="radio-label"><input type="radio" name="pr03" value="Tidak tahu" onchange="saveData()"><span>Tidak tahu</span></label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">PR-04. Status proyek:</label>
                    <select class="form-select" id="pr04" onchange="saveData()">
                        <option value="">-- Pilih status --</option>
                        <option value="Perencanaan">Perencanaan</option>
                        <option value="Penyiapan">Penyiapan</option>
                        <option value="Transaksi">Transaksi</option>
                        <option value="Konstruksi">Konstruksi</option>
                        <option value="Operasi">Operasi</option>
                        <option value="Selesai/terminasi">Selesai/terminasi</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">PR-05. Fase dominan pengalaman Anda: <span style="color:var(--danger)">*</span></label>
                    <select class="form-select" id="pr05" onchange="saveData()">
                        <option value="">-- Pilih fase --</option>
                        <option value="Perencanaan">Perencanaan</option>
                        <option value="Penyiapan">Penyiapan</option>
                        <option value="Transaksi">Transaksi</option>
                        <option value="Implementasi">Implementasi</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Kembali</button>
                    <button class="btn btn-primary" onclick="nextPage()">Lanjutkan <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
                </div>
            </div>
        </div>

        <!-- Page 4: FAHP -->
        <div class="page" id="page4">
            <div class="risk-sidebar">
                <h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg> Definisi 6 Risiko</h3>
                <div class="risk-item"><strong>R1 DCC</strong>Risiko desain, konstruksi, uji operasi (keterlambatan, cost overrun).</div>
                <div class="risk-item"><strong>R2 Financial</strong>Ketidakpastian pembiayaan, inflasi/kurs, struktur finansial.</div>
                <div class="risk-item"><strong>R3 Operations</strong>Layanan terhambat (pemeliharaan, cacat, teknologi usang).</div>
                <div class="risk-item"><strong>R4 Revenue</strong>Pendapatan tidak memenuhi proyeksi (permintaan/tarif).</div>
                <div class="risk-item"><strong>R5 Interface</strong>Ketidakselarasan antar pihak (metode, standar layanan).</div>
                <div class="risk-item"><strong>R6 Political</strong>Akibat kebijakan pemerintah (regulasi, perizinan, pajak).</div>
            </div>
            <div class="card">
                <h2 class="card-title"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3z"/><path d="M3 9h18"/><path d="M9 21V9"/></svg> FAHP: Perbandingan Berpasangan</h2>
                <p class="card-subtitle">Bandingkan tingkat kepentingan relatif antar risiko.</p>
                <div class="alert alert-info"><strong>Skala:</strong> SI=Sama | SLI=Sedikit Lebih | LI=Lebih | SVI=Sangat Lebih | EI=Ekstrem Lebih Penting</div>
                <div class="completeness incomplete" id="fahpCompleteness"><span>Terisi: <strong id="fahpCount">0</strong>/15</span></div>
                <div class="fahp-grid" id="fahpGrid"></div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Kembali</button>
                    <button class="btn btn-primary" onclick="nextPage()">Lanjutkan <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
                </div>
            </div>
        </div>

        <!-- Page 5: LCM -->
        <div class="page" id="page5">
            <div class="card">
                <h2 class="card-title"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20"/><path d="M2 12h20"/></svg> Lifecycle Mapping</h2>
                <p class="card-subtitle">Penilaian keterjadian risiko dan fase paling kritis.</p>
                <h3 style="margin:1.5rem 0 1rem;font-size:1.1rem">LCM-01. Skor Keterjadian (1â€“5)</h3>
                <div class="alert alert-info" style="margin-bottom:1rem">
                    <strong>Skala Keterjadian:</strong><br>
                    <span style="display:inline-block;margin-top:.5rem">
                        <strong>1</strong> = Sangat Jarang &nbsp;|&nbsp; 
                        <strong>2</strong> = Jarang &nbsp;|&nbsp; 
                        <strong>3</strong> = Kadang-kadang &nbsp;|&nbsp; 
                        <strong>4</strong> = Sering &nbsp;|&nbsp; 
                        <strong>5</strong> = Sangat Sering
                    </span>
                </div>
                <div style="overflow-x:auto"><table class="likert-grid"><thead><tr><th>Risiko</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr></thead><tbody id="lcm01Grid"></tbody></table></div>
                <h3 style="margin:2rem 0 1rem;font-size:1.1rem">LCM-02. Fase Paling Kritis (pilih 1 per risiko)</h3>
                <div style="overflow-x:auto"><table class="likert-grid"><thead><tr><th>Risiko</th><th>Perencanaan</th><th>Penyiapan</th><th>Transaksi</th><th>Implementasi</th></tr></thead><tbody id="lcm02Grid"></tbody></table></div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Kembali</button>
                    <button class="btn btn-primary" onclick="nextPage()">Lanjutkan <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
                </div>
            </div>
        </div>

        <!-- Page 6: PAT Tier-1 -->
        <div class="page" id="page6">
            <div class="card">
                <h2 class="card-title"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg> PAT Tier-1: Publik/PDAM â†” BU/SPV</h2>
                <p class="card-subtitle">Penilaian konstruk Principal-Agent Theory.</p>
                <div class="alert alert-info"><span class="tier-badge tier1">Tier-1</span> <strong>12 item per risiko</strong> â€” Skala: 1â€“5, TT=Tidak tahu</div>
                <div class="alert alert-warning" style="margin-top:.5rem">
                    <strong>Skala Penilaian (1â€“5):</strong><br>
                    <span style="display:inline-block;margin-top:.5rem">
                        <strong>1</strong> = Sangat Tidak Setuju &nbsp;|&nbsp; 
                        <strong>2</strong> = Tidak Setuju &nbsp;|&nbsp; 
                        <strong>3</strong> = Netral &nbsp;|&nbsp; 
                        <strong>4</strong> = Setuju &nbsp;|&nbsp; 
                        <strong>5</strong> = Sangat Setuju &nbsp;|&nbsp;
                        <strong>TT</strong> = Tidak Tahu
                    </span>
                </div>
                <div class="tab-container"><div class="tab-nav" id="pat1TabNav"></div><div id="pat1TabContent"></div></div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Kembali</button>
                    <button class="btn btn-primary" onclick="nextPage()">Lanjutkan ke Tier-2 <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
                </div>
            </div>
        </div>

        <!-- Page 7: PAT Tier-2 -->
        <div class="page" id="page7">
            <div class="card">
                <h2 class="card-title"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg> PAT Tier-2: BU/SPV â†” EPC/O&M</h2>
                <p class="card-subtitle">Penilaian konstruk PAT untuk hubungan BU/SPV dengan EPC/O&M.</p>
                <div class="alert alert-info"><span class="tier-badge tier2">Tier-2</span> <strong>8 item per risiko</strong> â€” Skala: 1â€“5, TT=Tidak tahu</div>
                <div class="alert alert-warning" style="margin-top:.5rem">
                    <strong>Skala Penilaian (1â€“5):</strong><br>
                    <span style="display:inline-block;margin-top:.5rem">
                        <strong>1</strong> = Sangat Tidak Setuju &nbsp;|&nbsp; 
                        <strong>2</strong> = Tidak Setuju &nbsp;|&nbsp; 
                        <strong>3</strong> = Netral &nbsp;|&nbsp; 
                        <strong>4</strong> = Setuju &nbsp;|&nbsp; 
                        <strong>5</strong> = Sangat Setuju &nbsp;|&nbsp;
                        <strong>TT</strong> = Tidak Tahu
                    </span>
                </div>
                <div class="tab-container"><div class="tab-nav" id="pat2TabNav"></div><div id="pat2TabContent"></div></div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Kembali</button>
                    <button class="btn btn-primary" onclick="nextPage()">Review & Submit <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
                </div>
            </div>
        </div>

        <!-- Page 8: Review -->
        <div class="page" id="page8">
            <div class="card">
                <h2 class="card-title"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 15l2 2 4-4"/></svg> Review & Submit</h2>
                <p class="card-subtitle">Periksa kembali jawaban Anda sebelum mengirim.</p>
                <div id="validationSummary"></div>
                <div class="review-section"><h4>Profil Responden</h4><div id="reviewScreening"></div></div>
                <div class="review-section"><h4>Proyek Referensi</h4><div id="reviewProject"></div></div>
                <div class="review-section"><h4>FAHP (15 pasangan)</h4><div id="reviewFahp"></div></div>
                <div class="review-section"><h4>Lifecycle Mapping</h4><div id="reviewLcm"></div></div>
                <div class="review-section"><h4>PAT Tier-1 & Tier-2</h4><div id="reviewPat"></div></div>
                <div class="form-group" style="margin-top:2rem">
                    <label class="form-label">Catatan tambahan (opsional):</label>
                    <textarea class="form-textarea" id="additionalNotes" placeholder="Konteks khusus atau alasan di balik jawaban..." onchange="saveData()"></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevPage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Kembali</button>
                    <button class="btn btn-accent btn-lg" onclick="submitSurvey()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg> Submit & Lihat Hasil</button>
                </div>
            </div>
        </div>

        <!-- Page 9: Results -->
        <div class="page" id="page9">
            <div class="card">
                <h2 class="card-title"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg> Hasil Analisis & Rekomendasi</h2>
                <p class="card-subtitle">Berdasarkan jawaban Anda, berikut hasil analisis alokasi risiko KPBU SPAM.</p>
                <div class="kpi-grid" id="kpiGrid"></div>
                <div class="model-flow">
                    <h3 style="text-align:center;margin-bottom:1rem">ðŸ“Š Alur Model Alokasi Risiko 2-Tier</h3>
                    <div class="flow-row">
                        <div class="flow-card input"><strong>INPUT</strong><br><small>FAHP Weights</small></div>
                        <div class="flow-card input"><strong>INPUT</strong><br><small>LCM Phases</small></div>
                        <div class="flow-card input"><strong>INPUT</strong><br><small>PAT Scores</small></div>
                    </div>
                    <div class="flow-arrow">â†“</div>
                    <div class="flow-row"><div class="flow-card process"><strong>PROSES</strong><br><small>Decision Logic (Controlâ€“Verifiabilityâ€“Incentivesâ€“Externality)</small></div></div>
                    <div class="flow-arrow">â†“</div>
                    <div class="flow-row">
                        <div class="flow-card output"><strong>Tier-1</strong><br><small>Publik; BU; atau Shared</small></div>
                        <div class="flow-card output" style="border-color:#ff9800;background:rgba(255,152,0,.1)"><strong>Tier-2</strong><br><small>BU; EPC/O&M; Shared atau N/A*</small></div>
                        <div class="flow-card output"><strong>Locks</strong><br><small>Governance</small></div>
                    </div>
                    <div style="text-align:center;font-size:.8rem;color:var(--text-light);margin-top:1rem">* Jika Tier-1 = Gov/PDAM-lead â†’ Tier-2 = N/A, diganti <strong>Mitigation Controls</strong> (kontrol kinerja EPC/O&M, bukan transfer risiko)</div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Bobot FAHP 6 Risiko</div>
                    <div class="donut-container"><svg class="donut-chart" viewBox="0 0 200 200" id="donutChart"></svg><div class="donut-legend" id="donutLegend"></div></div>
                    <div class="bar-chart" id="fahpBarChart" style="margin-top:1.5rem"></div>
                </div>
                <div class="chart-container"><div class="chart-title">Lifecycle Mapping: Keterjadian & Fase Kritis</div><div class="heatmap" id="lcmHeatmap"></div></div>
                <div class="chart-container"><div class="chart-title">Skor Konstruk PAT per Risiko</div><div class="radar-mini" id="patRadarGrid"></div></div>
                <div class="chart-container"><div class="chart-title">Matriks Alokasi Risiko 2-Tier</div><div style="overflow-x:auto"><table class="allocation-matrix" id="allocationMatrix"></table></div></div>
                <h3 style="margin:2rem 0 1rem">Detail per Risiko</h3>
                <div class="accordion" id="riskAccordion"></div>
                <div class="export-buttons">
                    <button class="btn btn-primary" onclick="downloadJSON()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="M7 10l5 5 5-5"/><path d="M12 15V3"/></svg> Unduh JSON</button>
                    <button class="btn btn-secondary" onclick="downloadCSV()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg> Unduh CSV</button>
                    <button class="btn btn-outline" onclick="window.print()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg> Cetak</button>
                </div>
                <div class="btn-group"><button class="btn btn-secondary" onclick="goToPage(0)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M9 22V12h6v10"/></svg> Kembali ke Awal</button></div>
            </div>
        </div>
    </main>

    <script>
    // Constants
    const RISKS=[{code:'R1',name:'DCC',fullName:'Designâ€“Constructionâ€“Commissioning',color:'#3498db'},{code:'R2',name:'Financial',fullName:'Financial',color:'#2ecc71'},{code:'R3',name:'Operations',fullName:'Operations',color:'#9b59b6'},{code:'R4',name:'Revenue',fullName:'Revenue',color:'#e74c3c'},{code:'R5',name:'Interface',fullName:'Interface',color:'#f39c12'},{code:'R6',name:'Political',fullName:'Political',color:'#1abc9c'}];
    const PHASES=['Perencanaan','Penyiapan','Transaksi','Implementasi'];
    const FAHP_SCALE={SI:{tfn:[1,1,1]},SLI:{tfn:[1,2,3]},LI:{tfn:[2,3,4]},SVI:{tfn:[3,4,5]},EI:{tfn:[4,5,6]},'1/SLI':{tfn:[1/3,1/2,1]},'1/LI':{tfn:[1/4,1/3,1/2]},'1/SVI':{tfn:[1/5,1/4,1/3]},'1/EI':{tfn:[1/6,1/5,1/4]}};
    const CRISP_SCALE={SI:1,SLI:2,LI:3,SVI:4,EI:5,'1/SLI':1/2,'1/LI':1/3,'1/SVI':1/4,'1/EI':1/5};
    const RI_TABLE={1:0,2:0,3:0.58,4:0.90,5:1.12,6:1.24};
    const STEPS=[{label:'Mulai'},{label:'Persetujuan'},{label:'Screening'},{label:'Proyek'},{label:'FAHP'},{label:'LCM'},{label:'PAT T1'},{label:'PAT T2'},{label:'Review'},{label:'Hasil'}];
    const PAT1_ITEMS=[{code:'PAT1-01',text:'Keputusan teknis BU/SPV berpengaruh langsung mengurangi risiko.',construct:'Control'},{code:'PAT1-02',text:'Kewenangan BU/SPV memadai untuk mengelola risiko.',construct:'Control'},{code:'PAT1-03',text:'Informasi lebih lengkap di BU/SPV dibanding publik.',construct:'Info'},{code:'PAT1-04',text:'Pengalaman lapangan BU/SPV lebih mampu merespons risiko.',construct:'Info'},{code:'PAT1-05',text:'Kinerja dapat diukur dengan indikator yang jelas.',construct:'Verifiability'},{code:'PAT1-06',text:'Biaya pemantauan kinerja masih wajar.',construct:'Verifiability'},{code:'PAT1-07',text:'Risiko terutama ditentukan faktor eksternal.',construct:'Externality',reverse:true},{code:'PAT1-08',text:'Perubahan risiko lebih dipengaruhi kebijakan/regulasi.',construct:'Externality',reverse:true},{code:'PAT1-09',text:'BU/SPV punya kemampuan finansial memadai.',construct:'Capacity'},{code:'PAT1-10',text:'BU/SPV punya kapasitas teknis memadai.',construct:'Capacity'},{code:'PAT1-11',text:'Kontrak mengatur KPI/SLA yang jelas.',construct:'Incentives'},{code:'PAT1-12',text:'Mekanisme pembayaran/penalti cukup jelas.',construct:'Incentives'}];
    const PAT2_ITEMS=[{code:'PAT2-01',text:'EPC/O&M memiliki pengaruh langsung terhadap faktor teknis.',construct:'Control'},{code:'PAT2-02',text:'Ruang lingkup kerja EPC/O&M memberi kendali cukup.',construct:'Control'},{code:'PAT2-03',text:'Kinerja EPC/O&M dapat diukur objektif.',construct:'Verifiability'},{code:'PAT2-04',text:'Hubungan kualitas kerja dan outcome dapat ditelusuri.',construct:'Verifiability'},{code:'PAT2-05',text:'Kontrak memungkinkan pengalihan risiko via harga/LD.',construct:'Incentives'},{code:'PAT2-06',text:'Ada mekanisme asuransi/perlindungan kontraktual.',construct:'Incentives'},{code:'PAT2-07',text:'EPC/O&M punya kapasitas finansial memadai.',construct:'Capacity'},{code:'PAT2-08',text:'EPC/O&M punya rekam jejak teknis relevan.',construct:'Capacity'}];

    // State
    let currentPage=0;
    let surveyData={meta:{consent:false,role:'',experience:'',phases:[],dualRole:false,projectRef:{}},fahp:{pairwise:{}},lcm:{exposure:{},phaseCritical:{}},pat1:{},pat2:{},results:null,additionalNotes:''};

    // Init
    document.addEventListener('DOMContentLoaded',function(){loadData();initStepper();initFAHP();initLCM();initPAT();updateUI()});

    function loadData(){const saved=localStorage.getItem('kpbu_spam_survey');if(saved){try{surveyData=JSON.parse(saved)}catch(e){}}RISKS.forEach(r=>{if(!surveyData.pat1[r.code])surveyData.pat1[r.code]={};if(!surveyData.pat2[r.code])surveyData.pat2[r.code]={}})}
    function saveData(){collectFormData();localStorage.setItem('kpbu_spam_survey',JSON.stringify(surveyData))}
    function resetAll(){if(confirm('Hapus semua data?')){localStorage.removeItem('kpbu_spam_survey');location.reload()}}

    function collectFormData(){
        surveyData.meta.consent=document.getElementById('consent')?.checked||false;
        const scr01=document.querySelector('input[name="scr01"]:checked');if(scr01)surveyData.meta.screening01=scr01.value;
        surveyData.meta.role=document.getElementById('scr02')?.value||'';
        const scr03=document.querySelector('input[name="scr03"]:checked');if(scr03)surveyData.meta.experience=scr03.value;
        surveyData.meta.phases=Array.from(document.querySelectorAll('input[name="scr04"]:checked')).map(el=>el.value);
        const scr05=document.querySelector('input[name="scr05"]:checked');if(scr05)surveyData.meta.dualRole=scr05.value==='Ya';
        const pr01=document.querySelector('input[name="pr01"]:checked');if(pr01)surveyData.meta.projectRef.type=pr01.value;
        surveyData.meta.projectRef.location=document.getElementById('pr02Location')?.value||'';
        const pr03=document.querySelector('input[name="pr03"]:checked');if(pr03)surveyData.meta.projectRef.payment=pr03.value;
        surveyData.meta.projectRef.status=document.getElementById('pr04')?.value||'';
        surveyData.meta.projectRef.phase=document.getElementById('pr05')?.value||'';
        document.querySelectorAll('.fahp-select').forEach(sel=>{const pair=sel.dataset.pair;if(sel.value)surveyData.fahp.pairwise[pair]=sel.value});
        RISKS.forEach(r=>{const exp=document.querySelector(`input[name="lcm01_${r.code}"]:checked`);if(exp)surveyData.lcm.exposure[r.code]=parseInt(exp.value);const phase=document.querySelector(`input[name="lcm02_${r.code}"]:checked`);if(phase)surveyData.lcm.phaseCritical[r.code]=phase.value});
        RISKS.forEach(r=>{PAT1_ITEMS.forEach(item=>{const input=document.querySelector(`input[name="pat1_${r.code}_${item.code}"]:checked`);if(input)surveyData.pat1[r.code][item.code]=input.value==='TT'?'TT':parseInt(input.value)});PAT2_ITEMS.forEach(item=>{const input=document.querySelector(`input[name="pat2_${r.code}_${item.code}"]:checked`);if(input)surveyData.pat2[r.code][item.code]=input.value==='TT'?'TT':parseInt(input.value)})});
        surveyData.additionalNotes=document.getElementById('additionalNotes')?.value||'';
    }

    function initStepper(){document.getElementById('stepper').innerHTML=STEPS.map((s,i)=>`<div class="step ${i===0?'active':''}" onclick="goToPage(${i})"><div class="step-number">${i}</div><div class="step-label">${s.label}</div></div>`).join('')}
    function updateStepper(){document.querySelectorAll('.step').forEach((step,i)=>{step.classList.remove('active','completed');if(i===currentPage)step.classList.add('active');else if(i<currentPage)step.classList.add('completed')});document.getElementById('progressFill').style.width=`${currentPage/9*100}%`;document.getElementById('progressText').textContent=`Halaman ${currentPage} dari 9`}
    function goToPage(n){saveData();currentPage=n;document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById(`page${n}`).classList.add('active');updateStepper();updateUI();window.scrollTo(0,0)}
    function nextPage(){if(currentPage<9)goToPage(currentPage+1)}
    function prevPage(){if(currentPage>0)goToPage(currentPage-1)}

    function updateUI(){updateConsent();updateScreening();updateFAHPCompleteness();updatePATTabs();if(currentPage===8)updateReview()}
    function updateConsent(){const consent=document.getElementById('consent'),next=document.getElementById('consentNext');if(consent&&next){next.disabled=!consent.checked;document.getElementById('consentLabel').classList.toggle('selected',consent.checked)}if(surveyData.meta.consent&&consent){consent.checked=true;document.getElementById('consentNext').disabled=false}}
    function updateScreening(){const scr01=document.querySelector('input[name="scr01"]:checked'),warn=document.getElementById('scr01Warning'),fields=document.getElementById('screeningFields');if(scr01){if(scr01.value==='Tidak'){warn.classList.remove('hidden');fields.classList.add('hidden')}else{warn.classList.add('hidden');fields.classList.remove('hidden')}}document.querySelectorAll('.radio-label,.checkbox-label').forEach(l=>{const i=l.querySelector('input');l.classList.toggle('selected',i&&i.checked)});restoreValues()}
    function restoreValues(){if(surveyData.meta.screening01){const el=document.querySelector(`input[name="scr01"][value="${surveyData.meta.screening01}"]`);if(el)el.checked=true}if(surveyData.meta.role)document.getElementById('scr02').value=surveyData.meta.role;if(surveyData.meta.experience){const el=document.querySelector(`input[name="scr03"][value="${surveyData.meta.experience}"]`);if(el)el.checked=true}if(surveyData.meta.phases)surveyData.meta.phases.forEach(p=>{const el=document.querySelector(`input[name="scr04"][value="${p}"]`);if(el)el.checked=true});if(surveyData.meta.dualRole!==undefined){const el=document.querySelector(`input[name="scr05"][value="${surveyData.meta.dualRole?'Ya':'Tidak'}"]`);if(el)el.checked=true}if(surveyData.meta.projectRef?.type){const el=document.querySelector(`input[name="pr01"][value="${surveyData.meta.projectRef.type}"]`);if(el)el.checked=true}if(surveyData.meta.projectRef?.location)document.getElementById('pr02Location').value=surveyData.meta.projectRef.location;if(surveyData.meta.projectRef?.payment){const el=document.querySelector(`input[name="pr03"][value="${surveyData.meta.projectRef.payment}"]`);if(el)el.checked=true}if(surveyData.meta.projectRef?.status)document.getElementById('pr04').value=surveyData.meta.projectRef.status;if(surveyData.meta.projectRef?.phase)document.getElementById('pr05').value=surveyData.meta.projectRef.phase;if(surveyData.additionalNotes)document.getElementById('additionalNotes').value=surveyData.additionalNotes}

    function initFAHP(){const pairs=[];for(let i=0;i<6;i++)for(let j=i+1;j<6;j++)pairs.push({r1:RISKS[i],r2:RISKS[j]});document.getElementById('fahpGrid').innerHTML=pairs.map(p=>{const k=`${p.r1.code}_${p.r2.code}`,v=surveyData.fahp.pairwise[k]||'';return`<div class="fahp-pair"><div class="fahp-risk left">${p.r1.code}<br><small>${p.r1.name}</small></div><select class="form-select fahp-select" data-pair="${k}" onchange="saveData();updateFAHPCompleteness()"><option value="">-- Pilih --</option><option value="EI" ${v==='EI'?'selected':''}>${p.r1.code} Ekstrem (EI)</option><option value="SVI" ${v==='SVI'?'selected':''}>${p.r1.code} Sangat (SVI)</option><option value="LI" ${v==='LI'?'selected':''}>${p.r1.code} Lebih (LI)</option><option value="SLI" ${v==='SLI'?'selected':''}>${p.r1.code} Sedikit (SLI)</option><option value="SI" ${v==='SI'?'selected':''}>Sama (SI)</option><option value="1/SLI" ${v==='1/SLI'?'selected':''}>${p.r2.code} Sedikit (1/SLI)</option><option value="1/LI" ${v==='1/LI'?'selected':''}>${p.r2.code} Lebih (1/LI)</option><option value="1/SVI" ${v==='1/SVI'?'selected':''}>${p.r2.code} Sangat (1/SVI)</option><option value="1/EI" ${v==='1/EI'?'selected':''}>${p.r2.code} Ekstrem (1/EI)</option></select><div class="fahp-risk right">${p.r2.code}<br><small>${p.r2.name}</small></div></div>`}).join('')}
    function updateFAHPCompleteness(){const c=Array.from(document.querySelectorAll('.fahp-select')).filter(s=>s.value).length;document.getElementById('fahpCount').textContent=c;const ind=document.getElementById('fahpCompleteness');ind.classList.toggle('complete',c===15);ind.classList.toggle('incomplete',c!==15)}

    function initLCM(){document.getElementById('lcm01Grid').innerHTML=RISKS.map(r=>{const s=surveyData.lcm.exposure[r.code];return`<tr><td><strong>${r.code}</strong> ${r.name}</td>${[1,2,3,4,5].map(v=>`<td><input type="radio" name="lcm01_${r.code}" value="${v}" ${s===v?'checked':''} onchange="saveData()"></td>`).join('')}</tr>`}).join('');document.getElementById('lcm02Grid').innerHTML=RISKS.map(r=>{const s=surveyData.lcm.phaseCritical[r.code];return`<tr><td><strong>${r.code}</strong> ${r.name}</td>${PHASES.map(p=>`<td><input type="radio" name="lcm02_${r.code}" value="${p}" ${s===p?'checked':''} onchange="saveData()"></td>`).join('')}</tr>`}).join('')}

    function initPAT(){['pat1','pat2'].forEach(tier=>{const items=tier==='pat1'?PAT1_ITEMS:PAT2_ITEMS;document.getElementById(`${tier}TabNav`).innerHTML=RISKS.map((r,i)=>`<button class="tab-btn ${i===0?'active':''}" data-tab="${tier}_${r.code}" onclick="switchTab('${tier}','${r.code}')">${r.code}</button>`).join('');document.getElementById(`${tier}TabContent`).innerHTML=RISKS.map((r,i)=>{const data=surveyData[tier][r.code]||{};return`<div class="tab-content ${i===0?'active':''}" id="${tier}_${r.code}_content"><h4 style="margin-bottom:1rem;color:var(--primary)">${r.code}: ${r.fullName}</h4><div style="overflow-x:auto"><table class="likert-grid"><thead><tr><th style="width:40%">Pernyataan</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>TT</th></tr></thead><tbody>${items.map(item=>{const v=data[item.code];return`<tr><td style="text-align:left;font-weight:normal;font-size:.85rem"><strong>${item.code}</strong>${item.reverse?'*':''}: ${item.text}</td>${[1,2,3,4,5].map(n=>`<td><input type="radio" name="${tier}_${r.code}_${item.code}" value="${n}" ${v===n?'checked':''} onchange="saveData();updatePATTabs()"></td>`).join('')}<td><input type="radio" name="${tier}_${r.code}_${item.code}" value="TT" ${v==='TT'?'checked':''} onchange="saveData();updatePATTabs()"></td></tr>`}).join('')}</tbody></table></div></div>`}).join('')})}
    function switchTab(tier,code){document.querySelectorAll(`#${tier}TabNav .tab-btn`).forEach(b=>b.classList.remove('active'));document.querySelectorAll(`#${tier}TabContent .tab-content`).forEach(c=>c.classList.remove('active'));document.querySelector(`#${tier}TabNav .tab-btn[data-tab="${tier}_${code}"]`).classList.add('active');document.getElementById(`${tier}_${code}_content`).classList.add('active')}
    function updatePATTabs(){['pat1','pat2'].forEach(tier=>{const items=tier==='pat1'?PAT1_ITEMS:PAT2_ITEMS;RISKS.forEach(r=>{const btn=document.querySelector(`#${tier}TabNav .tab-btn[data-tab="${tier}_${r.code}"]`);const filled=items.filter(item=>document.querySelector(`input[name="${tier}_${r.code}_${item.code}"]:checked`)).length;btn.classList.toggle('completed',filled===items.length)})})}

    function updateReview(){collectFormData();const v=[{l:'Persetujuan',v:surveyData.meta.consent},{l:'Screening',v:surveyData.meta.screening01==='Ya'},{l:'Peran',v:!!surveyData.meta.role},{l:'Pengalaman',v:!!surveyData.meta.experience},{l:'Fase ditangani',v:surveyData.meta.phases?.length>0},{l:'Tipe proyek',v:!!surveyData.meta.projectRef?.type},{l:'Fase dominan',v:!!surveyData.meta.projectRef?.phase}];const fC=Object.keys(surveyData.fahp.pairwise).length;v.push({l:`FAHP (${fC}/15)`,v:fC===15});const lE=Object.keys(surveyData.lcm.exposure).length,lP=Object.keys(surveyData.lcm.phaseCritical).length;v.push({l:`LCM (${lE}/6, ${lP}/6)`,v:lE===6&&lP===6});let p1=0,p2=0;RISKS.forEach(r=>{p1+=Object.keys(surveyData.pat1[r.code]||{}).length;p2+=Object.keys(surveyData.pat2[r.code]||{}).length});v.push({l:`PAT T1 (${p1}/72)`,v:p1>=36},{l:`PAT T2 (${p2}/48)`,v:p2>=24});document.getElementById('validationSummary').innerHTML=`<ul class="validation-list">${v.map(x=>`<li class="${x.v?'valid':'invalid'}">${x.v?'âœ“':'âœ—'} ${x.l}</li>`).join('')}</ul>${v.some(x=>!x.v)?'<div class="alert alert-warning">Beberapa bagian belum lengkap.</div>':'<div class="alert alert-success">Semua bagian lengkap!</div>'}`;document.getElementById('reviewScreening').innerHTML=`<div class="review-item"><span>Peran:</span><strong>${surveyData.meta.role||'-'}</strong></div><div class="review-item"><span>Pengalaman:</span><strong>${surveyData.meta.experience||'-'}</strong></div><div class="review-item"><span>Fase:</span><strong>${surveyData.meta.phases?.join(', ')||'-'}</strong></div><div class="review-item"><span>Dual-role:</span><strong>${surveyData.meta.dualRole?'Ya':'Tidak'}</strong></div>`;document.getElementById('reviewProject').innerHTML=`<div class="review-item"><span>Tipe:</span><strong>${surveyData.meta.projectRef?.type||'-'}</strong></div><div class="review-item"><span>Lokasi:</span><strong>${surveyData.meta.projectRef?.location||'-'}</strong></div><div class="review-item"><span>Fase dominan:</span><strong>${surveyData.meta.projectRef?.phase||'-'}</strong></div>`;document.getElementById('reviewFahp').innerHTML=`<div class="review-item"><span>Terisi:</span><strong>${fC}/15</strong></div>`;document.getElementById('reviewLcm').innerHTML=`<div class="review-item"><span>Keterjadian:</span><strong>${lE}/6</strong></div><div class="review-item"><span>Fase kritis:</span><strong>${lP}/6</strong></div>`;document.getElementById('reviewPat').innerHTML=`<div class="review-item"><span>PAT Tier-1:</span><strong>${p1}/72</strong></div><div class="review-item"><span>PAT Tier-2:</span><strong>${p2}/48</strong></div>`}

    function calculateFAHP(){const n=6,pw=surveyData.fahp.pairwise;const tfnM=[];for(let i=0;i<n;i++){tfnM[i]=[];for(let j=0;j<n;j++)tfnM[i][j]=i===j?[1,1,1]:[1,1,1]}for(let i=0;i<n;i++)for(let j=i+1;j<n;j++){const k=`${RISKS[i].code}_${RISKS[j].code}`,v=pw[k];if(v&&FAHP_SCALE[v]){tfnM[i][j]=[...FAHP_SCALE[v].tfn];tfnM[j][i]=[1/tfnM[i][j][2],1/tfnM[i][j][1],1/tfnM[i][j][0]]}}const Gi=[];for(let i=0;i<n;i++){let pL=1,pM=1,pU=1;for(let j=0;j<n;j++){pL*=tfnM[i][j][0];pM*=tfnM[i][j][1];pU*=tfnM[i][j][2]}Gi.push([Math.pow(pL,1/n),Math.pow(pM,1/n),Math.pow(pU,1/n)])}const Gs=[0,0,0];Gi.forEach(g=>{Gs[0]+=g[0];Gs[1]+=g[1];Gs[2]+=g[2]});const GsI=[1/Gs[2],1/Gs[1],1/Gs[0]];const Wi=Gi.map(g=>[g[0]*GsI[0],g[1]*GsI[1],g[2]*GsI[2]]);const wS=Wi.map(w=>(w[0]+w[1]+w[2])/3);const sum=wS.reduce((a,b)=>a+b,0);const weights=wS.map(w=>w/sum);const crispM=[];for(let i=0;i<n;i++){crispM[i]=[];for(let j=0;j<n;j++){if(i===j)crispM[i][j]=1;else if(i<j){const k=`${RISKS[i].code}_${RISKS[j].code}`;crispM[i][j]=CRISP_SCALE[pw[k]]||1}else crispM[i][j]=1/crispM[j][i]}}const Aw=[];for(let i=0;i<n;i++){let s=0;for(let j=0;j<n;j++)s+=crispM[i][j]*weights[j];Aw.push(s)}const lambdas=Aw.map((v,i)=>weights[i]>0?v/weights[i]:0);const lMax=lambdas.reduce((a,b)=>a+b,0)/n;const CI=(lMax-n)/(n-1),CR=CI/RI_TABLE[n];return{weights,CR,CRPass:CR<0.10,lambdaMax:lMax}}
    function calculateLCM(){const r={};RISKS.forEach(ri=>r[ri.code]={exposure:surveyData.lcm.exposure[ri.code]||null,phase:surveyData.lcm.phaseCritical[ri.code]||null});return r}
    function calculatePAT(){const r={tier1:{},tier2:{}};RISKS.forEach(ri=>{const t1D=surveyData.pat1[ri.code]||{},t1C={Control:[],Info:[],Verifiability:[],Externality:[],ExternalityRaw:[],Capacity:[],Incentives:[]};PAT1_ITEMS.forEach(item=>{const v=t1D[item.code];if(v!==undefined&&v!=='TT'){if(item.construct==='Externality'){t1C.ExternalityRaw.push(v);t1C.Externality.push(6-v)}else t1C[item.construct].push(v)}});const mean=arr=>arr.length>0?arr.reduce((a,b)=>a+b,0)/arr.length:null;r.tier1[ri.code]={Control:mean(t1C.Control),Info:mean(t1C.Info),Verifiability:mean(t1C.Verifiability),Externality:mean(t1C.ExternalityRaw),ExternalityReversed:mean(t1C.Externality),Capacity:mean(t1C.Capacity),Incentives:mean(t1C.Incentives),ttCount:PAT1_ITEMS.filter(i=>t1D[i.code]==='TT').length,totalItems:PAT1_ITEMS.length};const t2D=surveyData.pat2[ri.code]||{},t2C={Control:[],Verifiability:[],Incentives:[],Capacity:[]};PAT2_ITEMS.forEach(item=>{const v=t2D[item.code];if(v!==undefined&&v!=='TT')t2C[item.construct].push(v)});r.tier2[ri.code]={Control:mean(t2C.Control),Verifiability:mean(t2C.Verifiability),Incentives:mean(t2C.Incentives),Capacity:mean(t2C.Capacity),ttCount:PAT2_ITEMS.filter(i=>t2D[i.code]==='TT').length,totalItems:PAT2_ITEMS.length}});return r}
    function determineAllocation(pat,code){const t1=pat.tier1[code],t2=pat.tier2[code];let tier1Alloc='Shared',tier1Reason='Kontrol terbagi/verifiability sedang.';if(t1.Control>=4&&t1.Verifiability>=3&&t1.Incentives>=3&&t1.Externality<=3){tier1Alloc='BU/SPV';tier1Reason='Control tinggi, verifiability & incentives memadai.'}else if(t1.Externality>=4||t1.Control<3){if(t1.Control<3){tier1Alloc='Publik/PDAM';tier1Reason='Control BU/SPV rendah, risiko ditahan pemerintah.'}else{tier1Alloc='Publik/PDAM';tier1Reason='Externality tinggi (â‰¥4), risiko dominan faktor eksternal.'}}let tier2Alloc,tier2Reason,mitigationControls=[];if(tier1Alloc==='Publik/PDAM'){tier2Alloc='N/A';tier2Reason='Tier-2 tidak diterapkan untuk domain publik-lead.';mitigationControls=deriveMitigationControls(t2,code)}else{if(t2.Control>=4&&t2.Verifiability>=4){tier2Alloc='EPC/O&M';tier2Reason='Control & verifiability tinggi, transfer risiko layak.'}else if(t2.Control>=3&&t2.Verifiability>=3){tier2Alloc='Shared';tier2Reason='Control/verifiability sedang, berbagi dengan BU/SPV.'}else{tier2Alloc='BU/SPV-retain';tier2Reason='Control/verifiability rendah, BU/SPV menahan risiko.'}}return{tier1:{allocation:tier1Alloc,reason:tier1Reason},tier2:{allocation:tier2Alloc,reason:tier2Reason,mitigationControls}}}
    function deriveMitigationControls(t2,code){const controls=[];controls.push('KPI teknis terukur (availability, kualitas output, response time)');controls.push('Milestone readiness & commissioning checklist');controls.push('Audit access & data transparency clause');if(t2.Verifiability<3.5)controls.push('Third-party verification pada milestone kritis');if(t2.Control>=3)controls.push('Performance bond/retention terkait pencapaian teknis');if(t2.Incentives<3.5)controls.push('Payment trigger berbasis milestone (bukan lump-sum)');controls.push('Defect liability period dengan jaminan pemeliharaan');return controls.slice(0,5)}
    function determineGovernanceLocks(alloc,pat,code,dualRole){const locks=[],t1=pat.tier1[code],t2=pat.tier2[code];const isGovLead=alloc.tier1.allocation==='Publik/PDAM';if(isGovLead){locks.push('âš ï¸ MEKANISME KOMPENSASI: Klausul penyesuaian tarif/AP untuk perubahan regulasi/kebijakan');locks.push('âš ï¸ RISK RESERVE: Alokasi anggaran kontingensi untuk risiko yang ditahan');locks.push('Eskalasi & force majeure clause dengan definisi jelas');locks.push('Periodic review clause untuk kondisi eksternal berubah');if(t1.Verifiability<3.5)locks.push('Dashboard monitoring real-time untuk deteksi dini');if(t1.Incentives<3.5)locks.push('Performance framework internal PDAM dengan reward/consequence')}if(alloc.tier1.allocation==='Shared'||alloc.tier2.allocation==='Shared'){locks.push('RACI/Interface Charter dengan definisi batas tanggung jawab');locks.push('KPI terukur dengan metode pengukuran disepakati');locks.push('Akses data & audit trail')}if(!isGovLead){if(t1.Verifiability<3.5||t2.Verifiability<3.5){locks.push('Verifikasi independen pada milestone kritis');locks.push('Definisi KPI/metode ukur spesifik')}if(t1.Incentives<3.5||t2.Incentives<3.5){locks.push('Payment trigger/holdback terkait kinerja');locks.push('Mekanisme insentif-disinsentif jelas')}}if(dualRole){locks.push('Pengaman dual-role: separasi fungsi & firewall');locks.push('Approval independen keputusan kritis')}if(locks.length<3){locks.push('KPI terukur dengan definisi data jelas');locks.push('Akses data & audit trail');locks.push('Mekanisme eskalasi & sengketa')}return[...new Set(locks)].slice(0,6)}
    function determineConfidence(fahp,pat,code){const t1=pat.tier1[code],t2=pat.tier2[code];const tt1=t1.ttCount/t1.totalItems,tt2=t2.ttCount/t2.totalItems;const weak=t1.Control===null||t1.Verifiability===null||t2.Control===null||t2.Verifiability===null;if(!fahp.CRPass||tt1>0.4||tt2>0.4||weak)return{level:'Rendah',reason:'CR tidak lolos/TT tinggi/data lemah'};if(tt1>0.2||tt2>0.2)return{level:'Sedang',reason:'TT moderat (20-40%)'};return{level:'Tinggi',reason:'CR lolos, TT rendah, data lengkap'}}

    function submitSurvey(){saveData();const fahp=calculateFAHP(),lcm=calculateLCM(),pat=calculatePAT();const alloc={},locks={},conf={};RISKS.forEach(r=>{alloc[r.code]=determineAllocation(pat,r.code);locks[r.code]=determineGovernanceLocks(alloc[r.code],pat,r.code,surveyData.meta.dualRole);conf[r.code]=determineConfidence(fahp,pat,r.code)});surveyData.results={fahp,lcm,pat,allocations:alloc,governanceLocks:locks,confidence:conf,timestamp:new Date().toISOString()};saveData();goToPage(9);renderResults()}

    function renderResults(){const res=surveyData.results;if(!res)return;const shared=RISKS.filter(r=>res.allocations[r.code].tier1.allocation==='Shared'||res.allocations[r.code].tier2.allocation==='Shared').length;const avgExp=Object.values(res.lcm).filter(l=>l.exposure!==null).reduce((s,l)=>s+l.exposure,0)/6;const topR=RISKS.reduce((m,r,i)=>res.fahp.weights[i]>res.fahp.weights[m]?i:m,0);document.getElementById('kpiGrid').innerHTML=`<div class="kpi-card ${res.fahp.CRPass?'success':'warning'}"><div class="kpi-value">${(res.fahp.CR*100).toFixed(1)}%</div><div class="kpi-label">CR ${res.fahp.CRPass?'âœ“ Lolos':'âš  Review'}</div></div><div class="kpi-card"><div class="kpi-value">${RISKS[topR].code}</div><div class="kpi-label">Top Risk (${(res.fahp.weights[topR]*100).toFixed(1)}%)</div></div><div class="kpi-card"><div class="kpi-value">${avgExp.toFixed(1)}</div><div class="kpi-label">Rata-rata Keterjadian</div></div><div class="kpi-card ${shared>3?'warning':''}"><div class="kpi-value">${shared}</div><div class="kpi-label">Risiko Shared</div></div>`;document.getElementById('fahpBarChart').innerHTML=RISKS.map((r,i)=>`<div class="bar-item"><div class="bar-label"><strong>${r.code}</strong> ${r.name}</div><div class="bar-track"><div class="bar-fill" style="width:${res.fahp.weights[i]*100*3}%;background:${r.color}"></div></div><div class="bar-value">${(res.fahp.weights[i]*100).toFixed(1)}%</div></div>`).join('');renderDonutChart(res.fahp.weights);document.getElementById('lcmHeatmap').innerHTML=`<div class="heatmap-header"></div>${PHASES.map(p=>`<div class="heatmap-header">${p}</div>`).join('')}${RISKS.map(r=>{const l=res.lcm[r.code];const cls=!l.exposure?'':l.exposure<=2?'heat-low':l.exposure<=3?'heat-medium':l.exposure<=4?'heat-high':'heat-critical';return`<div class="heatmap-cell heatmap-risk"><strong>${r.code}</strong> ${r.name} (${l.exposure||'-'})</div>${PHASES.map(p=>`<div class="heatmap-cell ${l.phase===p?cls:''}">${l.phase===p?'â—':''}</div>`).join('')}`}).join('')}`;document.getElementById('patRadarGrid').innerHTML=RISKS.map(r=>{const t1=res.pat.tier1[r.code],t2=res.pat.tier2[r.code];return`<div class="radar-card"><div class="radar-title">${r.code}: ${r.name}</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem"><div><small style="color:var(--text-light)">Tier-1</small><div class="construct-bars">${['Control','Verifiability','Incentives'].map(c=>`<div class="construct-bar"><span>${c.slice(0,4)}</span><div class="construct-track"><div class="construct-fill" style="width:${(t1[c]||0)/5*100}%"></div></div><span>${t1[c]?.toFixed(1)||'-'}</span></div>`).join('')}</div></div><div><small style="color:var(--text-light)">Tier-2</small><div class="construct-bars">${['Control','Verifiability','Incentives'].map(c=>`<div class="construct-bar"><span>${c.slice(0,4)}</span><div class="construct-track"><div class="construct-fill" style="width:${(t2[c]||0)/5*100}%;background:#9b59b6"></div></div><span>${t2[c]?.toFixed(1)||'-'}</span></div>`).join('')}</div></div></div></div>`}).join('');document.getElementById('allocationMatrix').innerHTML=`<thead><tr><th>Risiko</th><th>Bobot</th><th>Fase</th><th>Tier-1</th><th>Tier-2</th><th>Conf</th></tr></thead><tbody>${RISKS.map((r,i)=>{const a=res.allocations[r.code],c=res.confidence[r.code];const t1c=a.tier1.allocation==='Publik/PDAM'?'alloc-public':a.tier1.allocation==='BU/SPV'?'alloc-spv':'alloc-shared';const isGovLead=a.tier1.allocation==='Publik/PDAM';const t2c=isGovLead?'alloc-na':a.tier2.allocation==='EPC/O&M'?'alloc-epc':a.tier2.allocation==='BU/SPV-retain'?'alloc-spv':'alloc-shared';const cc=c.level==='Tinggi'?'confidence-high':c.level==='Sedang'?'confidence-medium':'confidence-low';return`<tr><td><strong>${r.code}</strong> ${r.name}</td><td>${(res.fahp.weights[i]*100).toFixed(1)}%</td><td>${res.lcm[r.code].phase||'-'}</td><td class="${t1c}">${a.tier1.allocation}</td><td class="${t2c}">${a.tier2.allocation}${isGovLead?'*':''}</td><td class="${cc}">${c.level}</td></tr>`}).join('')}</tbody><tfoot><tr><td colspan="6" style="font-size:.8rem;color:var(--text-light);text-align:left;padding-top:1rem">* N/A = Tier-2 tidak diterapkan. Untuk risiko dengan Government/PDAM-lead, tidak ada transfer risiko ke EPC/O&M, namun <strong>Mitigation Controls</strong> tetap direkomendasikan sebagai kontrol kinerja teknis.</td></tr></tfoot>`;document.getElementById('riskAccordion').innerHTML=RISKS.map((r,i)=>{const a=res.allocations[r.code],l=res.governanceLocks[r.code],c=res.confidence[r.code];const cc=c.level==='Tinggi'?'confidence-high':c.level==='Sedang'?'confidence-medium':'confidence-low';const isGovLead=a.tier1.allocation==='Publik/PDAM';const mitControls=a.tier2.mitigationControls||[];return`<div class="accordion-item"><div class="accordion-header" onclick="toggleAccordion(this)"><span><strong>${r.code}</strong>: ${r.fullName} â€” <span class="${cc}">Conf: ${c.level}</span></span><svg class="accordion-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></div><div class="accordion-content"><div style="margin-bottom:1rem"><strong>Bobot:</strong> ${(res.fahp.weights[i]*100).toFixed(1)}% | <strong>Keterjadian:</strong> ${res.lcm[r.code].exposure||'-'}/5 | <strong>Fase:</strong> ${res.lcm[r.code].phase||'-'}</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem"><div style="padding:1rem;background:${isGovLead?'#fff3e0':'#e3f2fd'};border-radius:8px;${isGovLead?'border:2px solid #ff9800':''}"><strong style="color:${isGovLead?'#e65100':'#1565c0'}">Tier-1: ${a.tier1.allocation}</strong>${isGovLead?'<span style="display:inline-block;margin-left:.5rem;padding:2px 8px;background:#ff9800;color:#fff;border-radius:4px;font-size:.7rem">RISIKO DITAHAN</span>':''}<p style="font-size:.85rem;margin-top:.5rem">${a.tier1.reason}</p></div><div style="padding:1rem;background:${isGovLead?'#f5f5f5':'#f3e5f5'};border-radius:8px"><strong style="color:${isGovLead?'#757575':'#7b1fa2'}">Tier-2: ${a.tier2.allocation}</strong><p style="font-size:.85rem;margin-top:.5rem">${a.tier2.reason}</p></div></div>${isGovLead&&mitControls.length>0?`<div style="margin-bottom:1rem;padding:1rem;background:linear-gradient(135deg,#e8f5e9 0%,#f1f8e9 100%);border-radius:8px;border-left:4px solid #4caf50"><strong style="color:#2e7d32">ðŸ› ï¸ Mitigation Controls untuk EPC/O&M:</strong><p style="font-size:.8rem;color:#555;margin:.5rem 0">Bukan transfer risiko, melainkan kontrol kinerja teknis untuk mencegah kegagalan implementasi memperburuk risiko publik.</p><ul style="margin:.5rem 0 0 1rem;font-size:.85rem">${mitControls.map(m=>`<li style="margin:.25rem 0">${m}</li>`).join('')}</ul></div>`:''}<div style="margin-bottom:1rem"><strong>${isGovLead?'âš ï¸ Governance Locks (Risiko Ditahan Publik):':'ðŸ”’ Governance Locks:'}</strong><ul class="locks-list" style="margin-top:.5rem">${l.map(x=>`<li>${x}</li>`).join('')}</ul></div><div style="font-size:.85rem;color:var(--text-light)"><strong>Confidence:</strong> ${c.level} â€” ${c.reason}</div></div></div>`}).join('')}
    function toggleAccordion(h){h.classList.toggle('active');h.nextElementSibling.classList.toggle('active')}
    function renderDonutChart(w){const svg=document.getElementById('donutChart'),leg=document.getElementById('donutLegend');let cum=0;const paths=[];const cx=100,cy=100,r=70;RISKS.forEach((ri,i)=>{const ang=w[i]*360,sA=cum*360,eA=sA+ang;const x1=cx+r*Math.cos((sA-90)*Math.PI/180),y1=cy+r*Math.sin((sA-90)*Math.PI/180);const x2=cx+r*Math.cos((eA-90)*Math.PI/180),y2=cy+r*Math.sin((eA-90)*Math.PI/180);const la=ang>180?1:0;if(w[i]>0.001)paths.push(`<path d="M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${la} 1 ${x2} ${y2} Z" fill="${ri.color}" stroke="white" stroke-width="2"/>`);cum+=w[i]});svg.innerHTML=paths.join('')+`<circle cx="${cx}" cy="${cy}" r="40" fill="white"/>`;leg.innerHTML=RISKS.map((r,i)=>`<div class="legend-item"><div class="legend-color" style="background:${r.color}"></div><span><strong>${r.code}</strong> ${r.name}: ${(w[i]*100).toFixed(1)}%</span></div>`).join('')}

    function downloadJSON(){const d={meta:surveyData.meta,fahp:surveyData.fahp,lcm:surveyData.lcm,pat1:surveyData.pat1,pat2:surveyData.pat2,results:surveyData.results,notes:surveyData.additionalNotes,exportedAt:new Date().toISOString()};const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`kpbu-survey-${new Date().toISOString().slice(0,10)}.json`;a.click();URL.revokeObjectURL(url)}
    function downloadCSV(){const r=surveyData.results;if(!r)return;const h=['Risk','Weight','Exposure','Phase','Tier1','Tier2','MitigationControls','Confidence'];const rows=RISKS.map((ri,i)=>{const a=r.allocations[ri.code];const mitCtrl=a.tier2.mitigationControls?.join('; ')||'';return[ri.code,(r.fahp.weights[i]*100).toFixed(2),r.lcm[ri.code].exposure||'',r.lcm[ri.code].phase||'',a.tier1.allocation,a.tier2.allocation,`"${mitCtrl}"`,r.confidence[ri.code].level]});const csv=[h.join(','),...rows.map(x=>x.join(','))].join('\n');const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`kpbu-results-${new Date().toISOString().slice(0,10)}.csv`;a.click();URL.revokeObjectURL(url)}
    </script>
</body>
</html>
